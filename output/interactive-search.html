<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
	<head>
    		<title>Reference implementation</title>
    	</head> 

<!-- This document is a reference implementation of the final output. 
Get things working here, then port code into corresponding areas of the wizard. -->

<body>
    		
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>

<!--Load the AJAX API-->  
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script type="text/javascript">
//Load the API and the controls package.  
  google.load('visualization', '1.1', {packages:['controls']});
</script>



<style type="text/css">
    /*	div styles */
    div.control1{width:620px; padding: 0 0 20px 0; font-size:0.9em; color:black; vertical-align: middle;margin:0;}
    div.control2{height:30px; width:300px;font-size:0.9em; padding: 0 20px 20px 0; vertical-align: middle;margin:0;}
    div.control3{float:right; height:30px; font-size:0.9em;vertical-align:inherit; vertical-align: middle;margin:0;}	
    div.chart1{float: left;} 
</style>

<script type="text/javascript" charset="utf-8">
    // jQuery plugin to extra URL vars
	$.extend({
      getUrlVars: function(){
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
          hash = hashes[i].split('=');
          vars.push(hash[0]);
          vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){
        return $.getUrlVars()[name];
      }
    });

</script>

<script type="text/javascript">
    
    // Assume we have no query vars to start
    anyquery = false; 
    
    // Get any known values from URL and pre-fill form fields if they exist
    fdnq = decodeURIComponent($.getUrlVar('fdnq'));
    fdop = decodeURIComponent($.getUrlVar('fdop'));
    fdtq = decodeURIComponent($.getUrlVar('fdtq'));
    fdall = decodeURIComponent($.getUrlVar('fdall'));    

    // If fdall param is present, override any others and do a full query
    if (fdall != 'undefined') {
       fdall = true; 
    } else {
        fdall = false;
    }  
    

 
    // Don't attempt to call the visualization code 
    // or display the dashboard unless we have search terms.
    // Set global anyquery var for use elsewhere.    
    if (fdtq != 'undefined' || fdnq != 'undefined' || fdall == true) {
       anyquery = true; 
       google.setOnLoadCallback(drawVisualization());
    } else {
        fdtq = 'Enter text';
        fdnq = 'Enter a number';        
    }; 
    
            
    // Render the chart - this function only called if we have query terms
    function drawVisualization() { 
         
        // ------------ Load data from google docs ----------------
        var search_url = 'https://spreadsheets.google.com/a/google.com/tq?key=0AtP_YtDJ532RdDcxZUl6Zkl4YkxKcEYzbld4ZDA4SlE'

        // Test strings
        // fdtq=A%20like%20'%25St%25'
        // fdnq=F%20%3E%200
        // fdtq=A%20like%20'%25St%25'&fdnq=F%20%3E%200


        // If one of these doesn't exist, it'll come back as string 'undefined'.
        // Blanking it out here simplifies the query generating code. 
        if (fdtq == 'undefined') {
            fdtq = '';
        };

        if (fdnq == 'undefined') {
            fdnq = '';
        };
        

        // If user clicked the Show all button, our query is simple
        // (but dangerously slow-loading). Otherwise we have to build it up.
        if (fdall) {
            var querystring = "select *";

        } else {
        
            // Query params exist. Start building string  
            var querystring = "select A,B,C,D,E,F where ";
    
            // Three possible conditionals here, depending 
            // on how they filled the search form
            // (they might have filled in one field, both fields, or neither)

            if (fdtq != '' && fdnq == '' ) {
                // We have a textquery but not a numquery        
                 querystring = querystring + " A like '%" + fdtq + "%'";

            } else if (fdtq == '' && fdnq != '' ) {
                // We have a numquery but not a textquery
                querystring = querystring + "F" + fdop + fdnq; 
    
            } else {
                // We have both a numquery and a textquery
                querystring = querystring + " A like '%" + fdtq + "%'" + " and " + "F" + fdop + fdnq;
            };   
        
        };  

        // URLencode query terms before appending to URL
        querystring = encodeURIComponent(querystring);  

        // Append encoded query terms to search URL
        search_url = search_url + "&tq=" + querystring;  

        var query = new google.visualization.Query(search_url);
        query.send(handleQueryResponse);  
        }   


        
    function handleQueryResponse(response) {
      if (response.isError()) {
    	console.log('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
    	return;
      }

    var data = response.getDataTable();   


// ------------ Draw dashboard ----------------

// Define a NumberRangeFilter slider control
  var slider = new google.visualization.ControlWrapper({
    'controlType': 'NumberRangeFilter',
    'containerId': 'control1',
    'options': {
      'filterColumnLabel': 'Contribution',  // Must match your data!
      'minValue': 0,
      // 'maxValue': 500000,
	'ui': {
		'label':'Adjust dollar range of contributions',
  }}
  });

// Define a StringFilter control
var stringFilter = new google.visualization.ControlWrapper({
  'controlType': 'StringFilter',
  'containerId': 'control2',
  'options': {
	'filterColumnLabel': 'Name', // Must match your data!
	'matchType':'any',
	'ui': {
		'label':'Filter contributors by name:',
		'cssClass' : 'custom-stringfilter'
  }}
});


// Define category pickers
var categoryPicker = new google.visualization.ControlWrapper({
'controlType': 'CategoryFilter',
'containerId': 'control3',
'options': {
  'filterColumnLabel': 'City', // Must match your data!
  'ui': {
	'label':'Pick a City',
    'allowTyping': false,
    'allowMultiple': false,
  }}
});
		
// Here's our table visualization in a wrapper
var table = new google.visualization.ChartWrapper({
  'chartType': 'Table',
  'containerId': 'chart1',
  'options': {'height': '25em', 'width': '820px','allowHtml':'true', 'title': 'Click a column header to sort', }
});

//Create the dashboard 
var dashboard = new google.visualization.Dashboard(document.getElementById('dashboard')).
// Configure the string to filter table and chart  [table, chart].
  bind([stringFilter,categoryPicker, slider], table).
  draw(data);   
  $('div#dashboard').show();   

}


</script>

<h3>
    Campaign contributions example
</h3>
<p>
    The example below is a spreadsheet of California Gov. Jerry Brown's monetary campaign contributions for the 2010 election. There are roughly 25,000 records and the full spreadsheet is available <a href="https://docs.google.com/spreadsheet/ccc?key=0AtP_YtDJ532RdDcxZUl6Zkl4YkxKcEYzbld4ZDA4SlE">here</a>. The data was downloaded from the California Secretary of State <a href="http://cal-access.sos.ca.gov/">web site</a>.
</p>
<div id="full_search" style=" width:100%; background-color:#DADADA; padding:10px 0 10px 20px;">
    <h2>
        Search the entire database
    </h2>
    <p>
        lead-in text
    </p>
    <p style="font-size:12px; line-height:30px">
        <label for="search_text">Name includes:</label> 
        <input id="search_text" value="Enter text" style="color:#656565"> 
            <span style="color:#3F3F3F; font-size:10px">Example:</span><br />
        
        <label for="range_num">Contribution</label> 
        <select name="sheet_op" id="sheet_op">
            <option value="&gt;=">Greater than or equal to</option>
            <option value="&lt;=">Less than or equal to</option>
            <option value="&gt;">Greater than</option>
            <option value="&lt;">Less than</option>
            <option value="=">Equals</option>
        </select> 
        
        <input id="range_num" value="Enter a number" style="color:#656565"> 
        <input type="submit" value="Search" onclick="refresh()"> 
            <span style="color:#3F3F3F; font-size:10px">Example:</span><br />
        <input type="submit" id="show_all" value="Show all records" onclick="refresh('allrecs')">
        <span style="color:#3F3F3F; font-size:10px">May cause long load times and browser slowdowns.</span>
    </p>
</div>

		
		
<!--Div that will hold the dashboard-->
<div id="dashboard" style='width: 620px;font-family:Arial, sans-serif;'>
	<h3>Explore your results</h3>
	<p>You can use the slider, text filter and picker to investigate your search results or click on a column label to resort the table. To perform a new search, use the tool above. 
	<div id="control1" class="control1"></div>
	<div id="control3" class="control3"></div>
	<div id="control2" class="control2"></div>
	<div id="chart1" class="chart1"></div>
</div>		
  

<script type="text/javascript" charset="utf-8" > 

    // Initially hide the dashboard
    if (typeof(anyquery == 'undefined')) {
        $('div#dashboard').hide(); 
    }; 
      
    // Pre-fill search fields from vars
    $('input#search_text').val(fdtq);
    $('input#range_num').val(fdnq);
    // Can't currently pre-set the value of the operator select box.
    // It would be possible with some jimmying, but very verbose. 
    // See bottom example at http://api.jquery.com/val/


    function refresh(allrecs) { 

        // The refresh() function strips our old values and adds new ones.
        // When search is clicked we get new values from form fields, build
        // an encoded URL string from them, and request a new page with new values. 
        // If fdall is true, we strip out all of our own params
        
        // We initially got our values from the URL, but now we set new vars to 
        // match what's been newly entered into search fields.
        var fdop = $('#sheet_op').val();
        var fdnq = $('#range_num').val();
        var fdtq = $('#search_text').val();
         
        // Get existing URL and start parsing
        var sURL = window.location.href;
        
        // Strip out our old URL params, leaving the host's originals and adding new ones back in.  
        // We can't just append to the URL because a person will likely do a 2nd, 3rd search etc.
        // And we can't know what params are already in the host's system, so we have to respect them.
        
        // Match either to the next ampersand or to the end of the line. It'll take the first 
        // match found, so it's important that the end of line option comes second, or it 
        // wipe out all params.
        sURL = sURL.replace(/(fdtq=.*&|fdtq=.*$)/gi,'');
        sURL = sURL.replace(/(fdnq=.*&|fdnq=.*$)/gi,'');
        sURL = sURL.replace(/(fdop=.*&|fdop=.*$)/gi,'');
        sURL = sURL.replace(/(fdall=.*&|fdall=.*$)/gi,'');        
        
        // It's possible to end up with a trailing & - remove if so.
        sURL = sURL.replace(/&$/,'') 
       
        // Build new query string. Need to pre-pend ? if not already present. 
        var qs = ''
        var found = sURL.search('\\?');
        if (found == -1) {
            qs = "?";
        };
        
        // Make sure we don't send the default field values back to the URL
        if (fdnq == "Enter a number") {fdnq = ''};
        if (fdtq == "Enter text") {fdtq = ''};        

        if (allrecs) {
            qs = qs + "fdall=true"
        } else {
            qs = qs + "&fdop=" + encodeURIComponent(fdop) + "&fdnq=" + encodeURIComponent(fdnq) + "&fdtq=" + encodeURIComponent(fdtq);            
        };

        // console.log(qs);

        // Append to URL
        sURL = sURL + qs;
         
        // Re-launch window with replacement URL
        window.location.replace(sURL);

     }  
     
     // function refresh_all() {
     //     // Show all records, even though it's slow for large spreadsheets
     //     var sURL = window.location.href;                
     //     
     //     // Remove our old params
     //     sURL = sURL.replace(/(fdtq=.*&|fdtq=.*$)/gi,'');
     //     sURL = sURL.replace(/(fdnq=.*&|fdnq=.*$)/gi,'');
     //     sURL = sURL.replace(/(fdop=.*&|fdop=.*$)/gi,'');  
     //     
     //     // It's possible to end up with a trailing & - remove if so.
     //     sURL = sURL.replace(/&$/,'') 
     // 
     //     // Build new query string. Need to pre-pend ? if not already present. 
     //     var qs = ''
     //     var found = sURL.search('\\?');
     //     if (found == -1) {
     //         qs = "?";
     //     }; 
     //     
     //     qs = qs + "&fdall=true"; 
     //     
     //     // Append to URL
     //     sURL = sURL + qs;
     // 
     //     // Re-launch window with replacement URL
     //     window.location.replace(sURL);
     //     
     // }     
</script>  

<script type="text/javascript" charset="utf-8">
    $(document).ready(function(){   
        
        // Clear range field when clicked in IF it contains the default value
        $('input#range_num').focus(function() {
            if($(this).val() == 'Enter a number') $(this).val('');           
        }).blur(function() {
            if( $(this).val() == '') $(this).val('Enter a number');
        }); 
        
        // Do same for text input field
        $('input#search_text').focus(function() {
            if($(this).val() == 'Enter text') $(this).val(''); 
        }).blur(function() {
            if( $(this).val() == '') $(this).val('Enter text');
        });        
    });
</script>
	
</body>
</html>
