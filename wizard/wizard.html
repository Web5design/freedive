<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Freedive 0.1 - Generate embeddable filter tables from Google Docs data</title>

<link href="styles/freedive.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery.smartWizard-2.0.min.js"></script>

<script type="text/javascript" src="http://use.typekit.com/qfd4pcz.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>


<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="js/iframe_top.js"></script>
<script type="text/javascript"> google.load('visualization', '1.1', {packages:['controls']}); </script>

<script type="text/javascript">
    $(document).ready(function(){
    	// Smart Wizard 	
        $('#wizard').smartWizard(
         {
          // Properties
            selected: 0,  // Selected Step, 0 = first step   
            keyNavigation: true, // Enable/Disable key navigation(left and right keys are used if enabled)
            enableAllSteps: false,  // Enable/Disable all steps on first load
            transitionEffect: 'fade', // Effect on navigation, none/fade/slide/slideleft
            contentURL:null, // specifying content url enables ajax content loading
            contentCache:true, // cache step contents, if false content is fetched always from ajax url
            cycleSteps: false, // cycle step navigation
            enableFinishButton: false, // makes finish button enabled always
            errorSteps:[],    // array of step numbers to highlighting as error steps
            labelNext:'Next', // label for Next button
            labelPrevious:'Previous', // label for Previous button
            labelFinish:'Finish',  // label for Finish button
                    
          // Events
            onLeaveStep: leaveAStepCallback, // triggers when leaving a step
            onShowStep: null,  // triggers when showing a step
            onFinish: onFinishCallback  // triggers when Finish button is clicked
         }
        );
      
      function onFinishCallback(){
        $('#wizard').smartWizard('showMessage','Please copy the embed code above to your clipboard.');
      } 

      function leaveAStepCallback(obj){
        // This function gets called after each step
        var step_num= obj.attr('rel'); // get the current step number

		 if(step_num == 1){

	            return true; // Return true so that navigation continues

		} else if(step_num == 2) {

            return true; // Return true so that navigation continues
        
        } else if(step_num == 3) {
            
            // Turn spinner on before we go and try to retrieve data 
            // (Spinner turned off at end of getTableMeta)
            $('#colfetch_spinner').show();  

            // Take input from step 1 and insert vals into the DOM so they're available in step 2
            spreadsheet_id = $('input[id=sheet_id_field]').val();
            $('#sheet_id').html(spreadsheet_id);
            getTableMeta(spreadsheet_id);
            
            return true; // Return true so that navigation continues


        } else if(step_num == 4) {

            // Need to make a new columns object that contains just
            // the checked columns (unlike cols_orig which contains all cols from spreadsheet).
            // This is tricky because the previous form element only sends the column IDs,
            // while we need both IDs and values, and we need the passed columns array
            // to have the same format as the original one.
            
            // Step through the checked columns, find the equivalent element
            // in orig_cols, and make it a key/val pair in the new object.   
            // Also build up a cols_as_text string for use in the embed code.
            
            columns = {}; 
            cols_as_text = '';
            $("input[name='cols_use']:checked").each(function(){
                temp = orig_cols[$(this).val()]; 
                columns[$(this).val()] = {label: temp.label};  
                cols_as_text += $(this).val() + ","; // But we want column IDs for the URL search query
            });  
            
            // Strip trailing comma from cols_as_text
            cols_as_text = cols_as_text.replace(/(^,)|(,$)/g, "") 

			// Populate dropdowns for step 5 from new array of usable columns
			populateDropDown(columns,'#pick_sortby_col');
			populateDropDown(columns,'#pick_main_col');  

            return true; // Return true so that navigation continues
            
              
        } else if(step_num == 5) {
                
            // Populate step 6 dropdowns when leaving step 5
            populateDropDown(columns,'#filter_col');
            populateDropDown(columns,'#picker_col');
            populateDropDown(columns,'#slider_col');            

    		// Store selected values for embed code
    		search_widget_col = $('select#pick_main_col').val();      
			number_widget_col = $('select#pick_sortby_col').val();   
			search_headline = $('input#search_headline').val();
            search_leadin = $('input#search_leadin').val(); 
            
            // Get actual column IDs for use in search, using our reverse lookup function.
            // Needed because we need column labels in the wizard, but need to convert
            // those into column IDs in the search/visualization.
            search_col_id = getColIdFromLabel(search_widget_col);
            num_col_id = getColIdFromLabel(number_widget_col);            
            
            return true; // Return true so that navigation continues

		} else if(step_num == 6) {
			
			// Collect inputs from step 6 
            filter_col = $('select#filter_col').val();
            filter_label = $('input[id=filter_label]').val();
            picker_col = $('select#picker_col').val();
            picker_label = $('input[id=picker_label]').val();
            slider_col = $('select#slider_col').val();
            slider_label = $('input[id=slider_label]').val(); 

            return true; // Return true so that navigation continues
			
		} else if(step_num == 7) {

    		// Collect inputs from step 7
    		table_width = $('input[id=table_width]').val();
    		table_height = $('input[id=table_height]').val();
		
            // Retrieve our hidden template and replace out variables 
		    embed_actual = $('textarea#embed_template').html();
		    embed_actual = embed_actual.replace(/SPREADSHEET_ID/g,spreadsheet_id);   
		    embed_actual = embed_actual.replace(/COLS_AS_TEXT/g,cols_as_text);
		    embed_actual = embed_actual.replace(/SLIDER_COL/g,slider_col);
		    embed_actual = embed_actual.replace(/SLIDER_LABEL/g,slider_label);		    		       
		    embed_actual = embed_actual.replace(/FILTER_COL/g,filter_col);
		    embed_actual = embed_actual.replace(/FILTER_LABEL/g,filter_label);		    		       
		    embed_actual = embed_actual.replace(/PICKER_COL/g,picker_col);
		    embed_actual = embed_actual.replace(/PICKER_LABEL/g,picker_label); 
		    embed_actual = embed_actual.replace(/TABLE_WIDTH/g,table_width); 
		    embed_actual = embed_actual.replace(/TABLE_HEIGHT/g,table_height); 
		    embed_actual = embed_actual.replace(/SEARCH_HEADLINE/g,search_headline); 
		    embed_actual = embed_actual.replace(/SEARCH_LEADIN/g,search_leadin);   
		    embed_actual = embed_actual.replace(/SEARCH_COL_ID/g,search_col_id);   
		    embed_actual = embed_actual.replace(/NUM_COL_ID/g,num_col_id);   		    		    
		    
		    // Prep output for display to user
            embed_actual = pseudoMinify(embed_actual); 
    		iframe_actual = iframe_start+embed_actual+"&lt/body&gt&lt/html&gt";
		
    		// Send embed code to text fields at end of wizard
    		$('#table_embed_text').html(embed_actual);
    		$('#widget_embed_text').html(iframe_actual);  

            return true; // Return true so that navigation continues
   
        } else {
            return true; // Continue anyway
        }
        
      }      
   });

</script>

</head><body>


<table align="center" border="0" cellpadding="0" cellspacing="0">
<tr><td> 
<!-- Smart Wizard -->
  		<div id="wizard" class="swMain">
  			<ul>
  				<li><a href="#step-1">
                <label class="stepNumber">1</label>
            </a></li>
  				<li><a href="#step-2">
                <label class="stepNumber">2</label>
            </a></li>
  				<li><a href="#step-3">
                <label class="stepNumber">3</label>                  
             </a></li>
  				<li><a href="#step-4">
                <label class="stepNumber">4</label>
            </a></li>
				<li><a href="#step-5">
                <label class="stepNumber">5</label>
            </a></li>
				<li><a href="#step-6">
                <label class="stepNumber">6</label>
            </a></li>
				<li><a href="#step-7">
                <label class="stepNumber">7</label>
            </a></li>
				<li><a href="#step-8">
            	<label class="stepNumber">8</label>
	        </a>
  			</ul>
				<div id="step-1">	   
	            <h2 class="StepTitle">Get ready...</h2>

	            <p>For the best results, clean and edit your spreadsheet before you use this tool. If you don’t know how to clean data, <a href="http://multimedia.journalism.berkeley.edu/tutorials/cleaning-data/">read our tutorial</a>. Here are some things to keep in mind:</p>
				<div style="width:440px; height:180px;float:left">
				<h3 class="sub_head_fd">Requirements</h3>
					<ul class="ul_start">
						<li class="li_start">You must have at least <strong><em>one text column</em></strong>.</li>
						<li class="li_start">You must have at least <strong><em>one numeric column</em></strong>.
						<li class="li_start">You must have a <strong><em>single row of column labels</em></strong>. Multiple label rows will break the tool.</li>
						<li class="li_start">Format special characters such as thousand separators (,) and currency signs ($) in the Google Spreadsheet.</li>
						<li class="li_start">The spreadsheet must have exactly <strong><em>one worksheet</em></strong> (the default).</li>
						</ul>	
				</div>
				
				<div style="width:440px; height:250px; float:right">
				<h3 class="sub_head_fd">Recommendations</h3>
					<ul class="ul_start">
						<li class="li_start">Optimize your data for the Web for better performance. <strong><em>Delete everything you don’t need</em></strong> from your Google spreadsheet, including columns you don’t plan to publish and blank rows.</li>
						<li class="li_start"><strong><em>Arrange your columns</em></strong> in the order in which you would like them displayed.</li>
						<li class="li_start"><strong><em>Use a finished spreadsheet</em></strong>. If you must edit the Google spreadsheet, changes in will update automatically in the published graph. But editing can introduce errors that can break your table.</li>
						<li class="li_start"><strong><em>Do not use all caps text</em></strong>. It requires additional space and makes your chart harder to read.</li>
					</ul>	
				</div>	
	        </div>

    


			<div id="step-2">	
	            <h2 class="StepTitle">Get set...</h2>

				<div style="width:200px; height:250px; float:left">
     					<p>Next you need to make sure your spreadsheet is published and available on the web. There are two steps:</p>
     					<ol style="padding:0 0 0 15px;font-weight:bold;">
     	            <li><span style="font-weight:normal">Click the <b>File</b> menu and select <b>Publish to the Web</b>. Check <b>Automatically republish changes</b> and click <b>Start publishing</b>. <br /></li>
     	            <br/>
     				<li><span style="font-weight:normal">Open your Google Spreadsheet and click the <b>Share</b> button in the top right. Make the document viewable to anyone on the Web. <br /></li>
     	            </ol>
     		       <p>If you are still a little confused, the video to the right demonstrates how to publish.</p>
                </div>  
                
                <div style="width:660px;float:right;">
                    <iframe src="http://player.vimeo.com/video/31934760?title=0&amp;byline=0&amp;portrait=0" width="601" height="383" frameborder="0" webkitAllowFullScreen allowFullScreen></iframe>
                </div>
	       </div>


	
  			<div id="step-3">	
                <h2 class="StepTitle">Enter your spreadsheet ID</h2>
            

                <p>With your spreadsheet open, look in the URL for the term “key=” This will be followed by a unique ID made of letters and numbers. Copy just the ID and paste in the field below.</p>
    			<img src="images/freeDive-key.png">

             	<p>
                 	<div id="spreadsheet_id"></div>
                    <label for="sheet_id_field" style="font-size:1.3em;">Spreadsheet ID:</label>
					<input id="sheet_id_field" value="">  
                    <input type="button" id="sidtest" value="Test" class="buttonOthers" style="height:22px;">
                    <span id="sidtest_spinner"><img src="images/loader.gif" width="40" height="10" alt="Loader"></span>
                </p>
				<p><strong>Before continuing, please use the Test button to verify your spreadsheet. The test may take 30 seconds.</strong></p>
    			<p><em>TIP: If you want to work with the campaign contributions example, select the key in this link (text in bold):<br/>
    			<code>https://docs.google.com/spreadsheet/ccc?key=<b>0AtP_YtDJ532RdDcxZUl6Zkl4YkxKcEYzbld4ZDA4SlE</b>&hl=en_US#gid=0</code></em></p>
                
            </div>     

        
        
  			<div id="step-4">
            <h2 class="StepTitle">Select your columns</h2>	

			<p>You are working on spreadsheet: <strong><span id="sheet_id">&nbsp;</span></strong>. <br />
			   Please select the columns you want included in your table.<br />
			   <b>At least one column must contain numeric data.</b>
			</p>

			<p><em><b>Tip:</b> Limit the number of columns to fit the width of the content area on your site. For example, if your story area is 600 pixels wide, limit the number of columns to five or so. Too many columns in a small space can be very hard to read and will make the page load more slowly.  If you need to display more columns, consider publishing on a full-width page.</em></p>
            
            <p>
                Please select the columns you want to display (five-column limit recommended).</p>    
                
            <p id="colfetch_spinner">Retrieving column data... <img src="images/loader.gif" width="40" height="10" alt="Loader"></p> 
            
            <style type="text/css" media="screen">
                input[type='checkbox'] {
                    display:inline;
                    width:20px;
                }
                
                td {
                    width:300px;
                }
            </style>

            <p id="col_load_spinner"></p>
            
            <table >

                <tbody>
                    <tr id="colnames">
                        <!-- Cells populated by jQuery -->
                    </tr>
                    
                    <tr id="colids">
                        <!-- Column IDs populated by jQuery -->                        
                    </tr>
                 </tbody>
            </table>

            <div id="col_no_warn" class="alert"></div>
            
                    
        </div>                      
  			<div id="step-5">
            <h2 class="StepTitle">Decide what the user will search</h2>	

		    <p>The table will start with a widget that allows readers to search the entire database. 
		        After the initial results are displayed, they'll be able to apply filters.
            </p>
           
            
            
            <table>
	            <tr class="tr_align">  
	                	<td>
				         <h3 class="sub_head_fd">Describe the search</h3>

                       <label for="search_headline">Search label</label><br />
                       <input class="input_fd" id="search_headline" value=""><br />
                       <span class="help_text">e.g. "Search all contributions"</span><br /><br />
                       
                       <label class="search_leadin" for="search_leadin">Lead-in</label><br />
                       <input class="input_fd" id="search_leadin" value=""><br />	
                       <span class="help_text">Invite users to search the data. Include an example to get them started. e.g. "Enter the name of a contributor to find donations. For example, type in "Fred" or "Flintstone."</span>
	                 </td>
	                 	                
	                <td>
                    	<h3 class="sub_head_fd">Select a text column</h3>
                    	<p>Users can only search within a text column.</p>    

	                    <p>
	                		<select id="pick_main_col" class="select_menu">
	                            <!-- Options generated with jQuery -->
	                        </select>
	                    </p>

	                </td>
                
	                <td>
	                   <h3 class="sub_head_fd">Select a numeric column</h3>
	                   <p>Your table must have at least one column with numbers. They will be able to select "less than," "greater than," etc.    
	                   </p>
	                   <p>
	                        <select id="pick_sortby_col">
	                          <!-- Options generated with jQuery -->
	                        </select>
	                    </p>

	                </td>

	            </tr>
	        </table>
         </div>
  		
		<div id="step-6">
            <h2 class="StepTitle">Set up the results page</h2>
            	
            <p>
                FreeDive includes interactive filters on the results page. This allows your readers to refine their results. This is especially helpful with large databases. You must choose one column for each filter. To see the three types in use, check out this example.
            </p>

	            <table>
	                <tr class="tr_align">
	                    <td>
	                        <h3 class="sub_head_fd">Select a text column</h3>
	                        <p>
	                            <label for="filter_col">Field to use for text searches:</label><br />
	                            <select id="filter_col">
                                    <!-- Options populated with jQuery -->
	                            </select>
	                        </p>

	                        <p>
	                            <label for="filter_label">Label for search:</label><br />
	                            <input class="input_fd" type=text id="filter_label" value=""><br />
	                            <span class="help_text">e.g. "Search for a contributor by name:"</span>
	                        </p>  
	                        
							<p style="width:200px"> 
							    Allows users to search within a text column. For example, they can search for part of a name or a ZIP Code.
							</p>
	                    </td>

	                    <td>
	                        <h3 class="sub_head_fd">Select a category column</h3>
	                        <p>
	                            <label for="picker_col">Field to enable for filtering:</label><br />
	                            <select id="picker_col">
                                    <!-- Options populated with jQuery -->                                                        
	                            </select>
	                        </p>

	                        <p>
	                            <label for="picker_label">Label for filter:</label><br />
	                            <input class="input_fd" id="picker_label" value=""><br />
	                            <span class="help_text">e.g. "Pick a city:"</span>
	                        </p> 
	                        
							<p style="width:200px"> 
							    Allows users to select a category from a drop down menu. <em>TIP: Every attribute will be added to the picker list so use columns with limited attributes.</em>
							</p>
	                    </td>


	                    <td><h3 class="sub_head_fd">Select a numeric slider column</h3>
	                        <p>
	                            <label for="slider_col">Field to enable for range slider:</label><br />
	                            <select id="slider_col">
                                   <!-- Options populated with jQuery --> 

	                            </select>
	                        </p>

	                        <p>
	                            <label for="slider_label">Label for filter:</label><br />
	                            <input class="input_fd" id="slider_label" value=""><br />
	                            <span class="help_text">e.g. "Adjust dollar range of contributions:"</span>
	                        </p>
							<p style="width:200px"> Creates a slider tool so that users can change which range of data is included in the results.
							</p>
	                    </td>                    
	                </tr>
		            </table>

		</div>
		
  		<div id="step-7">
            <h2 class="StepTitle">Size</h2>
            	
            <p>Setting the size of your chart is very important. It directly impacts how your reader interacts with your data. Make it too small and the the value of the data is diminished in their eyes. Make it too big and it will overwhelm and scare them away.

            </p>
           	<h3 class="sub_head_fd">Width in pixels</h3>
			<label for="table_width" style="font-size:1.2em;">Width:  </label><input id="table_width" style="width:50px; text-align:right;" value="800"> <span style="font-size:1.2em;font-weight:normal;"> pixels</span>

			<p><em>TIP: We recommend that you make your chart the full width of your regular story or post content. This helps it integrate the table into your site. If you must display 7-10 columns, you may have to make the table the full width of your page.</em></p>
			<br />
			<label for="table_height" style="font-size:1.2em;">Height:  </label><input id="table_height" value="400" style="width:50px; text-align:right;"><span style="font-size:1.2em;font-weight:normal;"> pixels</span>
           <p><em>TIP: If the chart will be above a story, consider setting the height to 300-400 pixels. For example, this wizard is 450 pixels high so that if we need to display text below you will still be able to see it. If your table will stand alone on a page, 800 pixels or more of depth will give the reader access to more data and may be better.</em></p>
               			
        </div>

  			<div id="step-8">
            <h2 class="StepTitle">Congratulations! You’re done...</h2>

			<div id="table_embed" style="width:430px; float:left; margin-right:10px;">
				<h3 class="sub_head_fd">Embed code</h3>
				<p>Copy and paste this code into a or blog in HTML mode to display your table. The code is mainly javascript (which some platforms restrict) so you may have to ask someone with admin access to post it for you.</p>
				<textarea id="table_embed_text" style="width:410px; height:210px"></textarea>
				
			</div>
			
			<div id="widget_embed" style="width:440px; float:right">
				<h3 class="sub_head_fd">HTML page</h3>
				<p>You can choose to download your table as an html document. This table uses the FreeDive theme and looks a little better. It also makes it easier for you to customize the CSS to match your site.</p>
		            <textarea id="widget_embed_text" style="width:150px; height:20px; position:absolute;left:620px;visibility:hidden;" ></textarea>
		<!-- <input type="button" class="buttonOthers" value="Preview" onclick="preview_pop()" style="height:30px;"/> -->
		            <input type="button" class="buttonOthers" value=" Download HTML page " onclick="downloadTable()" style="height:30px;"/><br /><br />
					
					<span class="help_text"><b>Iframe instructions</b><ol>
						<li>Rename the downloaded file to <b>"yourname.html"</b></li><li>Upload the renamed page to your web server. Note the URL (web address) of where it's located.</li><li>Copy the code below and paste it into a web page.</li><li>Replace the <b>URL</b> text in the code below with the URL of your uploaded html page.</li></ol>  <code>&ltiframe src="<b>URL</b>" width="100%" height="300" frameborder="0"&gt
					  &ltp>Your browser does not support iframes.&lt/p&gt
					&lt/iframe&gt</code> </span>
			</div>
        </div>



  	</div>
<!-- End SmartWizard Content -->  		
 		
</td></tr>
</table>

<script type="text/javascript" charset="utf-8">

function preview_pop() {
	new_preview=window.open('','preview','height=700,width=800');
	var tmp = new_preview.document;
	tmp.write(document.getElementById('widget_embed_text').value);
	tmp.close();
}

		function downloadTable(){
						
			uriContent = "data:application/octet-stream," + encodeURIComponent(document.getElementById('widget_embed_text').value);			
			location.href = uriContent;
		};
		
</script>
		
<script type="text/javascript" charset="utf-8">

	$.extend({
      getUrlVars: function(){
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
          hash = hashes[i].split('=');
          vars.push(hash[0]);
          vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){
        return $.getUrlVars()[name];
      }
    });

</script>


<script type="text/javascript" charset="utf-8">
    // In-wizard functions
    
    // Populate any known parameters from URL
    var spreadsheet_id = $.getUrlVar('sid');
    $('input[id=sheet_id_field]').val(spreadsheet_id);  

    // Initially hide the loading spinners, then toggle on as needed
    $('#sidtest_spinner').hide();
    $('#colfetch_spinner').hide();    
    
    // Test SID for validity - throws an alert if SID is inaccessible. 
    $('input[id=sidtest]').click(function () { 
       $('#sidtest_spinner').show();           
       var testsid = $('input[id=sheet_id_field]').val();
       validateTable(testsid);                 
    });
        
    // Populate sets of original column checkboxes 
    function populateColCells(orig_cols) {
        $.each(orig_cols, function(column, value) { 
          $("tr#colnames").append('<td class="td_pick_cols">' + value.label + '</td>');        
        });
    }
    
    function populateColIDCells(orig_cols) {
        $.each(orig_cols, function(column, value) { 
          $("tr#colids").append('<td><input type="checkbox" name="cols_use" value="'+ column +'" /></td>');        
        });
    }   
    
    
    // Dropdown lists of columns appear at several places in the wizard, populated either with
    // the original list of columns or a subset. This function populates them as needed. 
    // Takes an object of column data to use and a CSS selector as args.  
    function populateDropDown(cols_ob,selector) { 
        $(selector).empty(); // Erase children first to prevent duplicate entries when they hit prev/next

        $.each(cols_ob, function(column, value) { 
          $(selector).append('<option value="'+ value.label +'">'+ value.label +'</option>');        
        });
    }     
    
    // For reverse lookups, retrieves a column ID (e.g. "B")
    // from "columns" object, given a column label.    
    function getColIdFromLabel(labelstring) {
        var matchcol = "undefined";
        $.each(columns, function(key, value) { 
          if (value.label.toString() == labelstring) { 
              matchcol = key;
          }; 
        });
        
        return matchcol;
    };    
    
    
    function pseudoMinify(s) {   
        // Convert our "template" code into embed code 
        // Gotcha - URLs contain // just like comments so removing comments
        // will also break URLs. Should be a better way to do this,
        // but for now, replacing http:// with httpZZZ and then back again at the end.
        s = s.replace(/https:\/\//gi, 'httpsZZZ'); // Preserve URLs cheap trick
        s = s.replace(/http:\/\//gi, 'httpZZZ'); // Preserve URLs cheap trick        
        
        s = s.replace(/\/\*.+?\*\/|\/\/.*(?=[\n\r])/g, ''); // Remove Javascript comments
        s = s.replace(/\n /,"\n"); // Remove spaces after linebreaks
        s = s.replace(/\s+/g," "); // Replace double spaces with single
        s = s.replace(/(\r\n|\n|\r)/gm,""); // Remove all possible linebreak types (flatten)   

        // Reverse the URL preservation cheap trick
        s = s.replace(/httpsZZZ/gi, 'https://'); // Preserve URLs cheap trick
        s = s.replace(/httpZZZ/gi, 'http://'); // Preserve URLs cheap trick
        
    	return s;
    }
      
    
    // Warn if user tries to select more than five columns
    function limitCols() {
    $('input[name=cols_use]').click(function () {
    selected = $('input[name="cols_use"]').filter(':checked').length;
    if (selected > 5){
        $('#wizard').smartWizard('showMessage','You have selected more than five columns. Are you sure you need all of them?');
            } else {
        $('div.msgBox').hide();
        }
      });
    }
</script>    


<script type="text/javascript" charset="utf-8">   

    // Validate spreadsheet ID step #1 (similar to getTableMeta)
    function validateTable(spreadsheet_id,response) {
		var query = new google.visualization.Query('https://spreadsheets.google.com/a/google.com/tq?key=' + spreadsheet_id);
    	query.send(validateQueryResponse);
    	}

    // Validate spreadsheet ID step #2 (similar to handleQueryResponse but without all the extra processing)
	function validateQueryResponse(response) {
        if (response.isError()) {
            alert('Error in query: ' + response.getMessage() +  '. Please click Previous and enter a different spreadsheet ID.');
           
        } else {
            alert('Spreadsheet is valid and accessible!');

        }
        // Turn off the spinner after tests.
        $('#sidtest_spinner').hide();   
    }
    


    // Get table metadata from Google
    function getTableMeta(spreadsheet_id,response) {
	    
    	// ------------ Load data from google docs ----------------
		var query = new google.visualization.Query('https://spreadsheets.google.com/a/google.com/tq?key=' + spreadsheet_id);
    	query.send(handleQueryResponse);
        
    	}

	function handleQueryResponse(response) {
        // Validation removed - we should always be working with a valid spreadsheet at this point.

        var data = response.getDataTable();
        var colNum = data.getNumberOfColumns();
        var rowNum = data.getNumberOfRows();

        // All columns into an "orig_cols" map (object literal)
        orig_cols = {};
        for (var i = 0; i < colNum; i++) {
            var key = data.B[i].id;
            orig_cols[key] = {
                label: data.B[i].label
            };
        } 
        
        // Populate original column cells with returned data
        // Make sure user doesn't select more than n columns
        populateColCells(orig_cols);
        populateColIDCells(orig_cols);
        limitCols();       


        // Example: How to iterate through cols array:
        // for(var col_id in orig_cols) {
        //  var label = orig_cols[col_id].label;
        //  console.log(col_id,label);
        // }  
        
        // Turn off the spinner after data is loaded
        $('#colfetch_spinner').hide();    
	}
</script> 




<!-- This textarea stores a multi-line Javascript variable we can 
search/replace through and minify on output to generate embed code 
(a workaround since Javascript provides no heredoc syntax). 
Javascript comments will be stripped out. For now, do not include HTML comments.
-->

<textarea id="embed_template">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>

<script type="text/javascript">
//Load the API and the controls package.  
  google.load('visualization', '1.1', {packages:['controls']});
</script>


<style type="text/css">
    /*	div styles */
    div.control1{width:620px; padding: 0 0 20px 0; font-size:0.9em; color:black; vertical-align: middle;margin:0;}
    div.control2{height:30px; width:300px;font-size:0.9em; padding: 0 20px 20px 0; vertical-align: middle;margin:0;}
    div.control3{float:right; height:30px; font-size:0.9em;vertical-align:inherit; vertical-align: middle;margin:0;}	
    div.chart1{float: left;} 
</style>


<script type="text/javascript" charset="utf-8">
    // jQuery plugin to extract URL vars
	$.extend({
      getUrlVars: function(){
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
          hash = hashes[i].split('=');
          vars.push(hash[0]);
          vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){
        return $.getUrlVars()[name];
      }
    });
</script>


<script type="text/javascript">

    // Assume we have no query vars to start
    anyquery = false; 

    // Get any known values from URL and pre-fill form fields if they exist.
    // Using fdxx nomenclature to keep FreeDive params from colliding with host site params.
    fdnq = decodeURIComponent($.getUrlVar('fdnq'));
    fdop = decodeURIComponent($.getUrlVar('fdop'));
    fdtq = decodeURIComponent($.getUrlVar('fdtq'));
    fdall = decodeURIComponent($.getUrlVar('fdall'));    

    // If fdall param is present, override any others and do a full query
    if (fdall != 'undefined') {
       fdall = true; 
    } else {
        fdall = false;
    };

    // Don't attempt to call the visualization code 
    // or display the dashboard unless we have search terms.
    // Set global anyquery var for use elsewhere.    
    if (fdtq != 'undefined' || fdnq != 'undefined' || fdall == true) {
       anyquery = true; 
       google.setOnLoadCallback(drawVisualization());
    } else {
        fdtq = 'Enter text';
        fdnq = 'Enter a number';        
    }; 


    // Render the chart - this function only called if we have query terms
    function drawVisualization() { 

        // ------------ Load data from google docs ----------------
        var search_url = 'https://spreadsheets.google.com/a/google.com/tq?key=SPREADSHEET_ID';

        // Test strings
        // fdtq=A%20like%20'%25St%25'
        // fdnq=F%20%3E%200
        // fdtq=A%20like%20'%25St%25'&fdnq=F%20%3E%200

        // If one of these doesn't exist, it'll come back as string 'undefined'.
        // Blanking it out here simplifies the query generating code. 
        if (fdtq == 'undefined') {
            fdtq = '';
        };

        if (fdnq == 'undefined') {
            fdnq = '';
        };

        // If user clicked the Show all button, our query is simple
        // (but dangerously slow-loading). Otherwise we have to build it up.
        if (fdall) {
            var querystring = "select *";

        } else {

            // Query params exist. Start building string  
            // var querystring = "select A,B,C,D,E,F where ";
            var querystring = "select COLS_AS_TEXT where ";

            // Three possible conditionals here, depending 
            // on how they filled the search form
            // (they might have filled in one field, both fields, or neither)

            if (fdtq != '' && fdnq == '' ) {
                // We have a textquery but not a numquery        
                 querystring = querystring + "SEARCH_COL_ID like '%" + fdtq + "%'";

            } else if (fdtq == '' && fdnq != '' ) {
                // We have a numquery but not a textquery
                querystring = querystring + "NUM_COL_ID" + fdop + fdnq; 

            } else {
                // We have both a numquery and a textquery
                querystring = querystring + "SEARCH_COL_ID like '%" + fdtq + "%'" + " and " + "NUM_COL_ID" + fdop + fdnq;
            };   

        };      
        
        // console.log(querystring);

        // URLencode query terms before appending to URL
        querystring = encodeURIComponent(querystring);  

        // Append encoded query terms to search URL
        search_url = search_url + "&tq=" + querystring;  
        // console.log(search_url);

        var query = new google.visualization.Query(search_url);
        query.send(handleQueryResponse);  
        }   



    function handleQueryResponse(response) {
      if (response.isError()) {
    	console.log('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
    	return;
      }

    var data = response.getDataTable();   


// ------------ Draw dashboard ----------------

// Define a NumberRangeFilter slider control
  var slider = new google.visualization.ControlWrapper({
    'controlType': 'NumberRangeFilter',
    'containerId': 'control1',
    'options': {
      'filterColumnLabel': 'SLIDER_COL',  // Must match your data!
      'minValue': 0,
      // 'maxValue': 500000,
	'ui': {
		'label':'SLIDER_LABEL',
  }}
  });

// Define a StringFilter control
var stringFilter = new google.visualization.ControlWrapper({
  'controlType': 'StringFilter',
  'containerId': 'control2',
  'options': {
	'filterColumnLabel': 'FILTER_COL', // Must match your data!
	'matchType':'any',
	'ui': {
		'label':'FILTER_LABEL',
		'cssClass' : 'custom-stringfilter'
  }}
});


// Define category pickers
var categoryPicker = new google.visualization.ControlWrapper({
'controlType': 'CategoryFilter',
'containerId': 'control3',
'options': {
  'filterColumnLabel': 'PICKER_COL', // Must match your data!
  'ui': {
	'label':'PICKER_LABEL',
    'allowTyping': false,
    'allowMultiple': false,
  }}
});

// Here's our table visualization in a wrapper
var table = new google.visualization.ChartWrapper({
  'chartType': 'Table',
  'containerId': 'chart1',
  'options': {'height': 'TABLE_HEIGHTpx', 'width': 'TABLE_WIDTHpx','allowHtml':'true', 'title': 'Click a column header to sort', }
});

//Create the dashboard 
var dashboard = new google.visualization.Dashboard(document.getElementById('dashboard')).
// Configure the string to filter table and chart  [table, chart].
  bind([stringFilter,categoryPicker, slider], table).
  draw(data);   
  $('div#dashboard').show();   

};
</script>

<div id="full_search" style=" width:100%; background-color:#DADADA; padding:10px 0 10px 20px;">
    <h2>
        SEARCH_HEADLINE
    </h2>
    <p>
        SEARCH_LEADIN
    </p>
    <p style="font-size:12px; line-height:30px">
        <label for="search_text">Name includes:</label> 
        <input id="search_text" value="Enter text" style="color:#656565"> 
            <span style="color:#3F3F3F; font-size:10px">Example:</span><br />

        <label for="range_num">Contribution</label> 
        <select name="sheet_op" id="sheet_op">
            <option value="&gt;=">Greater than or equal to</option>
            <option value="&lt;=">Less than or equal to</option>
            <option value="&gt;">Greater than</option>
            <option value="&lt;">Less than</option>
            <option value="=">Equals</option>
        </select> 

        <input id="range_num" value="Enter a number" style="color:#656565"> 
        <input type="submit" value="Search" onclick="refresh()"> 
            <span style="color:#3F3F3F; font-size:10px">Example:</span><br />
        <input type="submit" id="show_all" value="Show all records" onclick="refresh('allrecs')">
        <span style="color:#3F3F3F; font-size:10px">May cause long load times and browser slowdowns.</span>
    </p>
</div>


<div id="dashboard" style='width: 620px;font-family:Arial, sans-serif;'>
	<h3>Explore your results</h3>
	<p>You can use the slider, text filter and picker to investigate your search results or click on a column label to resort the table. To perform a new search, use the tool above. 
	<div id="control1" class="control1"></div>
	<div id="control3" class="control3"></div>
	<div id="control2" class="control2"></div>
	<div id="chart1" class="chart1"></div>
</div>		


<script type="text/javascript" charset="utf-8" > 

    // Initially hide the dashboard
    if (anyquery == false) {
        $('div#dashboard').hide(); 
    };                             
    

    // Pre-fill search fields from vars
    $('input#search_text').val(fdtq);
    $('input#range_num').val(fdnq);
    // Can't currently pre-set the value of the operator select box.
    // It would be possible with some jimmying, but very verbose. 
    // See bottom example at http://api.jquery.com/val/


    function refresh(allrecs) { 

        // The refresh() function strips our old values and adds new ones. 
        // Takes an optional "allrecs" arg for handling all-record searches.
        // When search is clicked we get new values from form fields, build
        // an encoded URL string from them, and request a new page with new values. 
        // If fdall is true, we strip out all of our own params.

        // We got initial values from the URL, but now we set new vars to 
        // match what user has entered into search fields.
        var fdop = $('#sheet_op').val();
        var fdnq = $('#range_num').val();
        var fdtq = $('#search_text').val();

        // Get existing URL and start parsing
        var sURL = window.location.href;

        // Strip out our old URL params, leaving the host's originals and adding new ones back in.  
        // We can't just append to the URL because a person will likely do a 2nd, 3rd search etc.
        // And we can't know what params are already in the host's system, so we have to respect them.

        // Match either to the next ampersand or to the end of the line. It'll take the first 
        // match found, so it's important that the end of line option comes second, or it 
        // wipe out all params.
        sURL = sURL.replace(/(fdtq=.*&|fdtq=.*$)/gi,'');
        sURL = sURL.replace(/(fdnq=.*&|fdnq=.*$)/gi,'');
        sURL = sURL.replace(/(fdop=.*&|fdop=.*$)/gi,'');
        sURL = sURL.replace(/(fdall=.*&|fdall=.*$)/gi,'');        

        // It's possible to end up with a trailing & - remove if so.
        sURL = sURL.replace(/&$/,'');

        // Build new query string. Need to pre-pend ? if not already present. 
        var qs = '';
        var found = sURL.search('\\?');
        if (found == -1) {
            qs = "?";
        };

        // Make sure we don't send the default field values back to the URL
        if (fdnq == "Enter a number") {fdnq = ''};
        if (fdtq == "Enter text") {fdtq = ''};        

        if (allrecs) {
            qs = qs + "fdall=true" ;
        } else {
            qs = qs + "&fdop=" + encodeURIComponent(fdop) + "&fdnq=" + encodeURIComponent(fdnq) + "&fdtq=" + encodeURIComponent(fdtq);            
        };

        // console.log(qs);

        // Append to URL
        sURL = sURL + qs;

        // Re-launch window with replacement URL
        window.location.replace(sURL);

     }  

</script>  

<script type="text/javascript" charset="utf-8">
    $(document).ready(function(){   

        // Clear range field when clicked in IF it contains the default value
        $('input#range_num').focus(function() {
            if($(this).val() == 'Enter a number') $(this).val('');           
        }).blur(function() {
            if( $(this).val() == '') $(this).val('Enter a number');
        }); 

        // Do same for text input field
        $('input#search_text').focus(function() {
            if($(this).val() == 'Enter text') $(this).val(''); 
        }).blur(function() {
            if( $(this).val() == '') $(this).val('Enter text');
        });        
    });
</script>
           
</textarea>
<!-- End hidden embed code generation template -->

</body>
</html>
